---
- name: Machine setup
  hosts: localhost
  connection: local
  gather_facts: true

  tasks:
    - name: Ensure custom zsh profile is loaded
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        line: "source ~/.zsh_profile"
        create: yes

    - name: Download zellij plugins
      block:
        - name: Ensure plugin directory exists
          ansible.builtin.file:
            path: "{{ zellij_plugin_dir }}"
            state: directory
            mode: '0755'

        - name: Download plugins if they don't exist
          ansible.builtin.get_url:
            url: "{{ item.value }}"
            dest: "{{ zellij_plugin_dir }}/{{ item.key }}.wasm"
            mode: '0644'
          loop: "{{ zellij_plugins | dict2items }}"
          loop_control:
            label: "{{ item.key }}"
      vars:
        zellij_plugin_dir: "{{ ansible_env.HOME }}/.config/zellij/plugins"
        zellij_plugins:
          zellij_forgot: "https://github.com/karimould/zellij-forgot/releases/latest/download/zellij_forgot.wasm"
          zjstatus: "https://github.com/dj95/zjstatus/releases/latest/download/zjstatus.wasm"

    - name: Download bat theme
      script: ./download_bat_theme.sh

    - name: Install Flatpaks
      community.general.flatpak:
        name:
          - app.zen_browser.zen
          - com.brave.Browser
          - com.spotify.Client
          - org.wezfurlong.wezterm
      when: ansible_distribution == "Fedora"

    - name: Copy Zen Browser theme
      script: ./zen_browser.py
      when: ansible_distribution == "Fedora"
